<section class="section">
  <div class="container">

    <!-- back button to station -->
    <a href="/station/{{station._id}}" class="button is-light mb-3">‚Üê Back to Station</a>

    <!-- station forecast title -->
    <h1 class="title">{{station.name}} Forecast</h1>
    <p class="is-size-5">
      üïí Local time: <strong id="nowTime">‚Äî:‚Äî</strong>
    </p>

    <!-- ========= current conditions ========= -->
    <div class="columns is-multiline">
      <div class="column is-12">
        <div class="box soft-card has-text-centered current-box">
          <div class="current-wrap">
            {{#if current.iconUrl}}
              <!-- weather icon from openweather -->
              <img class="owm-icon" src="{{current.iconUrl}}" alt="{{current.desc}}">
            {{/if}}
            <!-- current temperature -->
            <h1 class="is-size-1 current-temp">{{current.temp}}¬∞C</h1>
          </div>
          <!-- feels like text and description -->
          <p class="has-text-grey">Feels like {{current.feels}}¬∞C ¬∑ {{current.desc}}</p>
        </div>
      </div>

      <!-- ========= stat cards (location, wind, pressure, humidity)========= -->
      <!-- location -->
      <div class="column is-3">
        <div class="box soft-card stat-card">
          <div class="stat-icon">üìç</div>
          <div>
            <div class="stat-label">LOCATION</div>
            <div class="stat-value">Lat {{lat}}, Lng {{lon}}</div>
          </div>
        </div>
      </div>

      <!-- wind -->
      <div class="column is-3">
        <div class="box soft-card stat-card">
          <div class="stat-icon">üí®</div>
          <div>
            <div class="stat-label">WIND</div>
            <div class="stat-value">
              {{#if current.wind}}{{current.wind}} km/h ¬∑ {{current.windDeg}}¬∞{{else}}‚Äî{{/if}}
            </div>
          </div>
        </div>
      </div>

      <!-- pressure -->
      <div class="column is-3">
        <div class="box soft-card stat-card">
          <div class="stat-icon">‚è≤</div>
          <div>
            <div class="stat-label">PRESSURE</div>
            <div class="stat-value">{{#if current.pressure}}{{current.pressure}} hPa{{else}}‚Äî{{/if}}</div>
          </div>
        </div>
      </div>

      <!-- humidity -->
      <div class="column is-3">
        <div class="box soft-card stat-card">
          <div class="stat-icon">üíß</div>
          <div>
            <div class="stat-label">HUMIDITY</div>
            <div class="stat-value">{{#if current.humidity}}{{current.humidity}}%{{else}}‚Äî{{/if}}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ========= location map (openstreetmap)========= -->
    {{#if station.lat}}
      <div class="box soft-card">
        <h3 class="title is-6 mb-3">Map</h3>
        <iframe class="map-iframe"
          src="https://www.openstreetmap.org/export/embed.html?bbox={{station.lng}},{{station.lat}},{{station.lng}},{{station.lat}}&layer=mapnik&marker={{station.lat}},{{station.lng}}">
        </iframe>
      </div>
    {{/if}}

    <!-- ========= hourly forecast graph (next 48 hrs)========= -->
    <div class="box soft-card">
      <h2 class="title is-5">Hourly Forecast (Next 48 Hours)</h2>
      <canvas id="hourlyChart" height="160"></canvas>
    </div>

    <!-- ========= 5 day forecast ========= -->
    <div class="box soft-card">
      <h2 class="title is-5">5 Day Forecast</h2>
      <div id="dailyCards" class="columns is-desktop is-variable is-2"></div>
    </div>
  </div>
</section>

<!-- ========= page style ========= -->
<style>
  .soft-card { border: 1px solid #e9eef6; border-radius: 14px; background: #f7faff; }
  .map-iframe { width: 100%; height: 260px; border: 0; border-radius: 10px; }

  .current-box { padding-top: 1.25rem; padding-bottom: 1.25rem; }
  .current-wrap { display: inline-flex; align-items: center; gap: .5rem; }
  .owm-icon { width: 60px; height: 60px; image-rendering: -webkit-optimize-contrast; }
  .current-temp { margin: 0; }

  .stat-card { display: flex; align-items: center; gap: .75rem; background: #f2f7ff; border-color: #e3ecfb; }
  .stat-icon { font-size: 1.25rem; line-height: 1; }
  .stat-label { font-size: .75rem; letter-spacing: .06em; color: #6b7280; }
  .stat-value { font-weight: 600; }
</style>





<!-- chart graph js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// show local time and update every minute
(function initClock() {
  const elTime = document.getElementById("nowTime");
  const elTz = document.getElementById("tzName");

  let tz = "";
  try {
    // get system timezone name
    tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
  } catch (e) {
    tz = "";
  }

  if (elTz && !elTz.textContent.trim()) {
    // display timezone in page if empty
    elTz.textContent = tz;
  }

// run time update 
  function updateClock() {
    const now = new Date();
    try {
      // show time in 24 hour format
      elTime.textContent = now.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit",
        hour12: false,
        timeZone: tz || undefined
      });
    } catch (e) {
      elTime.textContent = now.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });
    }
  }

  updateClock(); // update time every minute
  setInterval(updateClock, 60000);
})();

// load data from server into arrays
const HOURLY = {{{hourlyJson}}} || [];
const DAILY  = {{{dailyJson}}}  || [];

console.log("hourly data from server:", HOURLY);
console.log("daily data from server:", DAILY);

// ================= hourly forecast chart =================

 // check if hourly graph canvas exists
const ctx = document.getElementById("hourlyChart");

if (!ctx) {
  console.log("no canvas with id hourlyChart found");
} else if (!Array.isArray(HOURLY) || HOURLY.length === 0) {
  console.log("hourly array is empty, chart not drawn");
} else {
  // take first 16 readings (48 hours)
  const next48Hours = [];
  const limit = 16;

  // collect forecast using a normal for loop
  for (let i = 0; i < limit && i < HOURLY.length; i = i + 1) {
    next48Hours.push(HOURLY[i]);
  }

  // build label and temp arrays: list for chart values
  const labels = [];
  const temps  = [];
  const descs  = [];
  const pops   = [];


// fill lists for chart display
  for (let j = 0; j < next48Hours.length; j = j + 1) {
    const h = next48Hours[j];
    labels.push(h.time.slice(11, 16));   // hh:mm
    temps.push(h.temp);
    descs.push(h.desc || "‚Äî");
    pops.push(h.pop || 0);
  }

  console.log("chart labels:", labels);
  console.log("chart temps:", temps);

  const hourlyChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [{
        label: "temperature (¬∞c)",
        data: temps,
        borderWidth: 2,
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function (context) {
              const i = context.dataIndex;
              return temps[i] + "¬∞c ¬∑ " + descs[i];
            },
            afterLabel: function (context) {
              const i = context.dataIndex;
              if (pops[i]) {
                return "pop: " + pops[i] + "%";
              }
              return "";
            }
          }
        }
      },
      scales: {. // labels for x and y axes
        x: { title: { display: true, text: "time" } },
        y: { title: { display: true, text: "temperature (¬∞c)" } }
      }
    }
  });
}

// ================= 5 day forecast cards =================

// check if daily card container exists
const dailyRoot = document.getElementById("dailyCards");

if (!dailyRoot) {
  console.log("no dailyCards container found");
} else if (!Array.isArray(DAILY) || DAILY.length === 0) {
  console.log("daily array is empty, cards not drawn");
} else {   // build 5 daily weather forecast cards
  for (let k = 0; k < 5 && k < DAILY.length; k = k + 1) {
    const d = DAILY[k];

    const col = document.createElement("div");
    col.className = "column is-one-fifth is-one-third-tablet is-half-mobile";

    const weekday = d.date  // get weekday short name
      ? new Date(d.date).toLocaleDateString([], { weekday: "short" })
      : "‚Äî";

    const iconHtml = d.iconUrl // build icon html if exists
      ? '<img class="owm-icon" src="' + d.iconUrl + '" alt="' + (d.desc || "") + '">'
      : "";

 // compose card html
    col.innerHTML = 
      '<div class="box soft-card has-text-centered">' +
        '<p class="is-size-6"><strong>' + weekday + "</strong></p>" +
        iconHtml +
        '<p class="mt-1">' + Math.round(d.tmax) + "¬∞ / " + Math.round(d.tmin) + "¬∞</p>" +
        "<p>" + (d.desc || "‚Äî") + "</p>" +
        "<p>POP: " + (d.pop || 0) + "%</p>" +
      "</div>";

    dailyRoot.appendChild(col);
  }
}
</script>
